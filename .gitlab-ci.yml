image: rust:1.70.0-slim-buster

stages:
  - build
  - test
  - publish
  - deploy
  - e2e_tests

before_script:
  - APP_FLAVOR=$(echo $CI_COMMIT_TAG | sed -n "s/^v.*-\(.*\)$/\1/p")
  - APP_FLAVOR=${APP_FLAVOR:-procivis}
  - APP_VERSION=$(echo $CI_COMMIT_TAG | sed -n "s/^\(v.*\)-.*$/\1/p")
  - APP_VERSION=${APP_VERSION:-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA}
  - IMAGE_NAME=$CI_REGISTRY_IMAGE/$APP_FLAVOR
  - IMAGE_TAG=$IMAGE_NAME:$APP_VERSION

.only_main_or_tag:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-.+$/'
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - when: never

build:
  stage: build
  script:
    - cargo build --release --features strict
  artifacts:
    expire_in: 1 hour
    paths:
      - target/release/core-server

tests:
  stage: test
  script:
    - rustup install nightly-2023-06-15
    - cargo install cargo2junit
    - cargo +nightly-2023-06-15 test --features strict -- -Z unstable-options --format json --report-time | cargo2junit > coverage.xml
  artifacts:
    expire_in: 1 hour
    paths:
      - coverage.xml
    reports:
      junit:
        - coverage.xml

linter:clippy:
  stage: test
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings
    - cargo clippy --message-format=json &> report.json
  artifacts:
    expire_in: 1 hour
    paths:
      - report.json

linter:rustfmt:
  stage: test
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

sonarqube-check:
  stage: test
  dependencies:
    - linter:clippy
    - tests
  needs:
    - linter:clippy
    - tests
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar" # Defines the location of the analysis task cache
    GIT_DEPTH: "0" # Tells git to fetch all the branches of the project, required by the analysis task
  script:
    - sonar-scanner
  allow_failure: true
  extends:
    - .only_main_or_tag

publish:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  dependencies: [build]
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN
    - docker build -t $IMAGE_TAG -f docker/Dockerfile .
    - >
      if [ "$CI_COMMIT_REF_NAME" == "main" ] ; then
        docker image tag $IMAGE_TAG $IMAGE_NAME:latest
        docker push $IMAGE_NAME:latest
      fi
    - docker push $IMAGE_TAG
    - docker logout
  extends:
    - .only_main_or_tag

test_e2e:
  stage: e2e_tests
  needs: [publish]
  variables:
    CORE_IMAGE_TAG: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  trigger:
    project: procivis/one/one-e2e-tests
    branch: main
    strategy: depend
  extends:
    - .only_main_or_tag

.deploy_k8s:
  image: registry.gitlab.procivis.ch/procivis/one/one-operations/az-helm-kubectl:1.25.7
  variables:
    DEPLOY_IMAGE_TAG: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
    K8S_TYPE: deployment
    HELM_APP_NAME: one-core
    HELM_PATH: onecorechart
  before_script:
    - az login --service-principal -u "$AD_APP_ID" -p "$AD_APP_SECRET" --tenant "$AD_TENANT_ID"
    - az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --admin
  script:
    - cd "$HELM_PATH"
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - helm dep build
    - >
      helm upgrade --install $HELM_APP_NAME .
      --values $HELM_VALUES_FILE
      --set "image.tag=$DEPLOY_IMAGE_TAG"
      --namespace $K8S_NAMESPACE
    - kubectl rollout restart $K8S_TYPE $HELM_APP_NAME-$HELM_PATH --namespace=$K8S_NAMESPACE

deploy:dev:
  stage: deploy
  extends:
    - .deploy_k8s
  variables:
    HELM_VALUES_FILE: values/desk.dev.one-trust-solution.yaml
    K8S_NAMESPACE: default
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"

deploy:test:
  stage: deploy
  extends:
    - .deploy_k8s
  variables:
    HELM_VALUES_FILE: values/desk.test.one-trust-solution.yaml
    K8S_NAMESPACE: one-test
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      when: manual

bitrise_ios_sdk:
  stage: deploy
  variables:
    # ONE-wallet project on Bitrise
    BITRISE_PROJECT_SLUG: 6ee8c26f-6d7b-4bcb-8ddc-be1ba3cd2687
    BITRISE_WORKFLOW: iOS_Core_SDK
  before_script:
    # dependencies of gitrise
    - apt-get update && apt-get install curl jq -y
  script:
    - >
      ./etc/gitrise.sh
      --access-token $BITRISE_API_ACCESS_TOKEN
      --slug $BITRISE_PROJECT_SLUG
      --workflow $BITRISE_WORKFLOW
      --branch "$CI_COMMIT_REF_NAME"
      --output "artifacts"
  extends:
    - .only_main_or_tag
  artifacts:
    paths:
      - artifacts
    expire_in: 10 days
